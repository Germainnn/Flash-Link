<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Launching BookMyShow Session</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 10%;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 1.5rem;
      color: #444;
    }
    #status {
      font-size: 1.1rem;
      margin-top: 1rem;
      word-break: break-all;
    }
    .spinner {
      margin: 2rem auto;
      border: 5px solid #eee;
      border-top: 5px solid #ff1842;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0%   { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #debug-info {
      margin-top: 20px;
      text-align: left;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      display: none;
      white-space: pre-wrap;
    }
    .debug-toggle {
      color: #999;
      cursor: pointer;
      margin-top: 20px;
      font-size: 12px;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h2>üîÑ Launching your session...</h2>
  <div class="spinner"></div>
  <p id="status">Preparing your booking session...</p>
  <div id="debug-info"></div>
  <div class="debug-toggle" onclick="toggleDebug()">Show Debug Info</div>

  <script>
    // ‚Äî‚Äî Debug helper ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function debugLog(msg) {
      console.log(msg);
      const dbg = document.getElementById('debug-info');
      const d = document.createElement('div');
      d.textContent = msg;
      dbg.appendChild(d);
    }
    function toggleDebug() {
      const dbg = document.getElementById('debug-info');
      const btn = document.querySelector('.debug-toggle');
      if (dbg.style.display==='block') {
        dbg.style.display='none'; btn.textContent='Show Debug Info';
      } else {
        dbg.style.display='block'; btn.textContent='Hide Debug Info';
      }
    }

    // ‚Äî‚Äî Base64 decode path ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function decodeSession(encoded) {
      try {
        const b64 = encoded.replace(/-/g,'+').replace(/_/g,'/');
        const json = atob(b64);
        return JSON.parse(json);
      } catch (e) {
        debugLog('‚ùå decodeSession error: '+e);
        document.getElementById('status').textContent = '‚ùå Error decoding session: '+e.message;
      }
      return null;
    }

    // ‚Äî‚Äî Cookie setter ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    function extractRootDomain(d) {
      if (!d) return null;
      d = d.replace(/^\./,'');
      const parts = d.split('.');
      return parts.length>1
        ? '.'+parts.slice(-2).join('.')
        : '.'+d;
    }
    function setCookie(name,value,domain) {
      try {
        if (domain) {
          document.cookie = `${name}=${value}; path=/; domain=${domain}; max-age=7200; Secure; SameSite=None`;
          debugLog(`üç™ ${name}‚Üí${domain}`);
          const root = extractRootDomain(domain);
          if (root!==domain) {
            document.cookie = `${name}=${value}; path=/; domain=${root}; max-age=7200; Secure; SameSite=None`;
            debugLog(`üç™ ${name}‚Üí${root}`);
          }
        }
        document.cookie = `${name}=${value}; path=/; max-age=7200`;
        debugLog(`üç™ ${name} (no domain)`);
        return true;
      } catch(e) {
        debugLog('‚ö†Ô∏è setCookie '+name+': '+e);
        return false;
      }
    }

    // ‚Äî‚Äî Main launcher ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
     async function launchSession() {
      const params    = new URLSearchParams(location.search);
      const fileParam = params.get('file');
      let session;

      if (fileParam) {
        document.getElementById('status')
                .textContent = 'üìÇ Loading session file: '+fileParam;
        try {
-         const resp = await fetch('/sessions/'+fileParam);
+         const resp = await fetch('sessions/'+fileParam);
          if (!resp.ok) throw new Error(resp.status+' '+resp.statusText);
          session = await resp.json();
          debugLog('‚úÖ Loaded JSON from sessions/'+fileParam);
        } catch(err) {
          debugLog('‚ùå fetch error: '+err);
          document.getElementById('status')
                  .textContent = '‚ùå Could not load session JSON: '+err.message;
          return;
        }
      } ‚Ä¶
    }
    document.addEventListener('DOMContentLoaded', launchSession);

      } else if (b64Param) {
        session = decodeSession(b64Param);
        if (!session) return;
        debugLog('‚úÖ Decoded session from Base64.');
      } else {
        document.getElementById('status').textContent = '‚ùå No session specified in URL (use ?file=‚Ä¶ or ?s=‚Ä¶)';
        return;
      }

      debugLog('Session data:\n'+JSON.stringify(session,null,2));

      // figure target URL + domain
      let target = session.queueit_url || session.url;
      const domain = session._domain || (target ? new URL(target).hostname : null);
      debugLog(`‚Üí target=${target}\n‚Üí domain=${domain}`);

      // apply cookies
      const ck = session.cookies;
      let count=0;
      if (ck && typeof ck==='object') {
        for (let k in ck) {
          if (setCookie(k, ck[k], domain)) count++;
        }
        document.getElementById('status').textContent =
          `‚úÖ Applied ${count} cookies. Preparing redirect‚Ä¶`;
      } else {
        document.getElementById('status').textContent =
          `‚ö†Ô∏è No cookies found in session data.`;
      }

      // inject token if needed
      if (session.queueittoken && !target.includes('queueittoken=')) {
        const sep = target.includes('?') ? '&' : '?';
        target += sep+'queueittoken='+session.queueittoken;
        debugLog('‚Üí added queueittoken to URL');
      }

      // countdown + redirect
      let n=3;
      const st = document.getElementById('status');
      const iv = setInterval(()=>{
        if (--n>0) {
          st.textContent = `‚úÖ Session ready. Redirecting in ${n}‚Ä¶`;
        } else {
          clearInterval(iv);
          debugLog('‚û°Ô∏è redirect to '+target);
          window.location.href = target;
        }
      },1000);
    }

    document.addEventListener('DOMContentLoaded', launchSession);
  </script>
</body>
</html>
