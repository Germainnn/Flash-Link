<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Launching BookMyShow Session</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 10%;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 1.5rem;
      color: #444;
    }
    #status {
      font-size: 1.1rem;
      margin-top: 1rem;
    }
    .spinner {
      margin: 2rem auto;
      border: 5px solid #eee;
      border-top: 5px solid #ff1842;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #debug-info {
      margin-top: 20px;
      text-align: left;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
    .debug-toggle {
      color: #999;
      cursor: pointer;
      margin-top: 20px;
      font-size: 12px;
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h2>🔄 Launching your session...</h2>
  <div class="spinner"></div>
  <p id="status">Preparing your booking session...</p>
  <div id="debug-info"></div>
  <div class="debug-toggle" onclick="toggleDebug()">Show Debug Info</div>
  
  <script>
    // Debug helper
    function debugLog(message) {
      const debugElement = document.getElementById("debug-info");
      const msgElement = document.createElement("div");
      msgElement.textContent = message;
      debugElement.appendChild(msgElement);
      console.log(message);
    }
    
    function toggleDebug() {
      const debugElement = document.getElementById("debug-info");
      const toggleElement = document.querySelector(".debug-toggle");
      if (debugElement.style.display === "none" || !debugElement.style.display) {
        debugElement.style.display = "block";
        toggleElement.textContent = "Hide Debug Info";
      } else {
        debugElement.style.display = "none";
        toggleElement.textContent = "Show Debug Info";
      }
    }
    
    function decodeSession(encoded) {
      try {
        // Replace URL-safe base64 characters back to standard base64
        const base64Fixed = encoded.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = atob(base64Fixed);
        return JSON.parse(decoded);
      } catch (e) {
        debugLog("❌ Failed to decode session: " + e.message);
        document.getElementById("status").textContent = `❌ Error decoding session: ${e.message}`;
        return null;
      }
    }
    
    function setCookie(name, value, domain) {
      try {
        // First try with the specific domain
        if (domain) {
          // Try with the domain provided
          document.cookie = `${name}=${value}; path=/; domain=${domain}; max-age=7200; Secure; SameSite=None`;
          debugLog(`Set cookie ${name} for domain ${domain}`);
          
          // Try with dot prefix if not already present
          if (!domain.startsWith('.')) {
            document.cookie = `${name}=${value}; path=/; domain=.${domain}; max-age=7200; Secure; SameSite=None`;
            debugLog(`Set cookie ${name} for domain .${domain}`);
          }
        }
        
        // Also try with the determined root domain
        const rootDomain = extractRootDomain(domain);
        if (rootDomain && rootDomain !== domain) {
          document.cookie = `${name}=${value}; path=/; domain=${rootDomain}; max-age=7200; Secure; SameSite=None`;
          debugLog(`Set cookie ${name} for root domain ${rootDomain}`);
        }
        
        // Set cookie without domain specification as a fallback
        document.cookie = `${name}=${value}; path=/; max-age=7200`;
        debugLog(`Set cookie ${name} without domain specification`);
        
        return true;
      } catch (e) {
        debugLog(`⚠️ Error setting cookie ${name}: ${e.message}`);
        return false;
      }
    }
    
    function extractRootDomain(domain) {
      if (!domain) return null;
      
      // Remove any leading dots
      domain = domain.replace(/^\./, '');
      
      // Split by dots and get the last two parts if there are at least two
      const parts = domain.split('.');
      if (parts.length >= 2) {
        return '.' + parts.slice(-2).join('.');
      }
      
      return '.' + domain;
    }
    
    function launchSession() {
      const urlParams = new URLSearchParams(window.location.search);
      const encoded = urlParams.get("s");
      
      if (!encoded) {
        document.getElementById("status").textContent = "❌ No session data found in URL.";
        return;
      }
      
      const session = decodeSession(encoded);
      
      if (!session) {
        document.getElementById("status").textContent = "❌ Invalid or corrupted session.";
        return;
      }
      
      debugLog("Session data: " + JSON.stringify(session, null, 2));
      
      // Determine the target URL and domain
      let targetUrl = session.queueit_url || session.url;
      const domain = session._domain || (targetUrl ? new URL(targetUrl).hostname : null);
      
      debugLog(`Target URL: ${targetUrl}`);
      debugLog(`Domain: ${domain}`);
      
      // Set all cookies
      if (typeof session.cookies === 'object') {
        let cookieCount = 0;
        
        // First check if we have a dictionary or array of cookies
        if (Array.isArray(session.cookies)) {
          // Handle array format
          for (const cookie of session.cookies) {
            if (cookie.name && cookie.value) {
              const cookieDomain = cookie.domain || domain;
              if (setCookie(cookie.name, cookie.value, cookieDomain)) {
                cookieCount++;
              }
            }
          }
        } else {
          // Handle dictionary format
          for (const [name, value] of Object.entries(session.cookies)) {
            if (setCookie(name, value, domain)) {
              cookieCount++;
            }
          }
        }
        
        document.getElementById("status").textContent = `✅ Applied ${cookieCount} cookies. Preparing redirect...`;
      } else {
        document.getElementById("status").textContent = "⚠️ No cookies found in session data.";
      }
      
      // Handle tokens if available
      if (session.queueittoken && !targetUrl.includes('queueittoken=')) {
        // Add queueittoken to URL if not already present
        debugLog("Adding queueittoken to URL");
        const separator = targetUrl.includes('?') ? '&' : '?';
        targetUrl = `${targetUrl}${separator}queueittoken=${session.queueittoken}`;
      }
      
      // Start redirect countdown
      let countdown = 3;
      document.getElementById("status").textContent = `✅ Session ready. Redirecting in ${countdown}...`;
      
      const interval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(interval);
          debugLog(`Redirecting to: ${targetUrl}`);
          window.location.href = targetUrl;
        } else {
          document.getElementById("status").textContent = `✅ Session ready. Redirecting in ${countdown}...`;
        }
      }, 1000);
    }
    
    // Start the session launching process
    document.addEventListener('DOMContentLoaded', launchSession);
  </script>
</body>
</html>
