<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Launching BookMyShow Session</title>
  <!-- your existing styles… -->
</head>
<body>
  <h2>🔄 Launching your session...</h2>
  <div class="spinner"></div>
  <p id="status">Preparing your booking session...</p>
  <div id="debug-info"></div>
  <div class="debug-toggle" onclick="toggleDebug()">Show Debug Info</div>

  <!-- pako only needed if you ever fall back to compressed URLs -->
  <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

  <script>
    function debugLog(msg) {
      const d = document.getElementById("debug-info");
      const e = document.createElement("div");
      e.textContent = msg;
      d.appendChild(e);
      console.log(msg);
    }
    function toggleDebug() {
      const d = document.getElementById("debug-info");
      const t = document.querySelector(".debug-toggle");
      if (d.style.display === "block") {
        d.style.display = "none"; t.textContent = "Show Debug Info";
      } else {
        d.style.display = "block"; t.textContent = "Hide Debug Info";
      }
    }
    function showError(msg) {
      document.getElementById("status").textContent = msg;
    }

    async function loadSession() {
      const p = new URLSearchParams(location.search);
      let session = null;

      if (p.has("file")) {
        const fn = p.get("file");
        debugLog("📂 Loading session file: " + fn);
        try {
          const res = await fetch(`/sessions/${fn}`);
          if (!res.ok) throw new Error(res.statusText);
          session = await res.json();
        } catch (e) {
          return showError("❌ Could not load session JSON: " + e.message);
        }
      }
      else if (p.has("s")) {
        // legacy: base64 or compressed
        session = decodeSession(p.get("s"));
        if (!session) return;
      }
      else {
        return showError("❌ No session data found in URL.");
      }

      debugLog("Session data: " + JSON.stringify(session, null,2));
      proceedWithSession(session);
    }

    function decodeSession(encoded) {
      try {
        // if you ever compressed it with zlib + base64:
        // const bin = atob(encoded.replace(/-/g,'+').replace(/_/g,'/'));
        // const buf = Uint8Array.from(bin, c=>c.charCodeAt(0));
        // const str = pako.inflate(buf, { to: 'string' });
        // return JSON.parse(str);

        // otherwise simple base64→JSON:
        const b = atob(encoded.replace(/-/g,'+').replace(/_/g,'/'));
        return JSON.parse(b);
      } catch (e) {
        showError("❌ Failed to decode session: " + e.message);
        debugLog("Decode error: " + e.stack);
        return null;
      }
    }

    function setCookie(name, value, domain) {
      document.cookie = `${name}=${value};path=/;domain=${domain};max-age=7200;Secure;SameSite=None`;
      debugLog(`Set ${name} on ${domain}`);
      // fallback without domain:
      document.cookie = `${name}=${value};path=/;max-age=7200`;
      return true;
    }

    function proceedWithSession(session) {
      const dom   = session._domain || (new URL(session.url||session.queueit_url, location).hostname);
      let target  = session.queueit_url || session.url;
      debugLog("Target URL: " + target);

      // apply cookies
      const ck = session.cookies;
      let count = 0;
      if (typeof ck === 'object') {
        for (const [k,v] of Object.entries(ck)) {
          setCookie(k, v, dom);
          count++;
        }
      }
      document.getElementById("status").textContent = `✅ Applied ${count} cookies. Redirecting soon…`;

      // append token if missing
      if (session.queueittoken && !target.includes("queueittoken=")) {
        const sep = target.includes("?") ? "&" : "?";
        target += `${sep}queueittoken=${session.queueittoken}`;
      }

      // redirect after a short countdown
      let sec = 3;
      const st = document.getElementById("status");
      const iv = setInterval(() => {
        if (--sec===0) {
          clearInterval(iv);
          debugLog("Redirect→ " + target);
          location.href = target;
        } else {
          st.textContent = `✅ Session ready. Redirecting in ${sec}…`;
        }
      }, 1000);
    }

    document.addEventListener("DOMContentLoaded", loadSession);
  </script>
</body>
</html>
