<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Queue Session Handler</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 5%;
      background-color: #f9f9f9;
    }
    h2 {
      font-size: 1.5rem;
      color: #444;
    }
    #status {
      font-size: 1.1rem;
      margin-top: 1rem;
    }
    .spinner {
      margin: 2rem auto;
      border: 5px solid #eee;
      border-top: 5px solid #ff1842;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    .queue-info {
      background-color: #fff4e5;
      border: 1px solid #ffcc80;
      padding: 15px;
      margin: 20px 0;
      border-radius: 5px;
      text-align: left;
    }
    .instructions {
      text-align: left;
      margin: 20px 0;
    }
    .instructions li {
      margin-bottom: 10px;
    }
    .target-url {
      word-break: break-all;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
      text-align: left;
      font-family: monospace;
    }
    .button {
      background-color: #ff1842;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 15px;
    }
    .cookie-status {
      font-size: 14px;
      margin-top: 20px;
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="queue-handler" style="display:none;">
      <h2>üöÄ Queue Session Handler</h2>
      <div class="queue-info">
        <p><strong>‚ö†Ô∏è This is a queue session, not an authenticated session.</strong></p>
        <p>You need to wait in the queue and solve any CAPTCHA challenges to get an authenticated session.</p>
      </div>
      
      <div class="instructions">
        <h3>Follow these steps:</h3>
        <ol>
          <li>Click the "Open Queue" button below to continue in the queue</li>
          <li>Wait until you reach the front of the queue</li>
          <li>Solve any CAPTCHA or verification if required</li>
          <li>Once you reach the booking page, you can capture that authenticated session</li>
        </ol>
      </div>
      
      <div>
        <p>Target URL:</p>
        <div class="target-url" id="queue-target-url"></div>
      </div>
      
      <button id="open-queue-btn" class="button">Open Queue</button>
    </div>
    
    <div id="auth-handler" style="display:none;">
      <h2>üîÑ Launching your session...</h2>
      <div class="spinner"></div>
      <p id="status">Preparing your booking session...</p>
      <div id="cookie-status" class="cookie-status"></div>
    </div>
  </div>
  
  <script>
    function decodeSession(encoded) {
      try {
        // Replace URL-safe base64 characters back to standard base64
        const base64Fixed = encoded.replace(/-/g, '+').replace(/_/g, '/');
        const decoded = atob(base64Fixed);
        return JSON.parse(decoded);
      } catch (e) {
        console.error("‚ùå Failed to decode session:", e);
        document.getElementById("status").textContent = `‚ùå Error decoding session: ${e.message}`;
        return null;
      }
    }
    
    function setCookie(name, value, domain) {
      // Try to set cookie with multiple domain options
      const domains = [
        domain || '.bookmyshow.com',
        domain?.startsWith('.') ? domain.substring(1) : domain,  // Try without leading dot
        'bookmyshow.com',
        '.bookmyshow.com',
        window.location.hostname
      ];
      
      domains.forEach(d => {
        if (!d) return;
        
        try {
          // Try with Secure and SameSite=None for cross-site access
          document.cookie = `${name}=${value}; path=/; domain=${d}; max-age=7200; Secure; SameSite=None`;
          
          // Also try without Secure/SameSite for older browsers
          document.cookie = `${name}=${value}; path=/; domain=${d}; max-age=7200`;
          
          log(`Set cookie ${name} for domain ${d}`);
        } catch (e) {
          log(`Failed to set cookie for domain ${d}: ${e}`);
        }
      });
    }
    
    function log(message) {
      const cookieStatus = document.getElementById("cookie-status");
      if (cookieStatus) {
        const line = document.createElement("div");
        line.textContent = message;
        cookieStatus.appendChild(line);
      }
      console.log(message);
    }
    
    function handleQueueSession(session) {
      document.getElementById("queue-handler").style.display = "block";
      document.getElementById("auth-handler").style.display = "none";
      
      // Set the target URL
      const targetUrl = session.url || session.queueit_url;
      document.getElementById("queue-target-url").textContent = targetUrl;
      
      // Set up the Open Queue button
      document.getElementById("open-queue-btn").addEventListener("click", function() {
        window.location.href = targetUrl;
      });
    }
    
    function handleAuthSession(session) {
      document.getElementById("queue-handler").style.display = "none";
      document.getElementById("auth-handler").style.display = "block";
      
      const statusElement = document.getElementById("status");
      statusElement.textContent = "Applying session cookies...";
      
      // Get the target URL and domain
      let targetUrl = session.url || session.queueit_url;
      const domain = session._domain || (targetUrl ? new URL(targetUrl).hostname : null);
      
      // Apply cookies
      let cookieCount = 0;
      if (session.cookies) {
        for (const [name, value] of Object.entries(session.cookies)) {
          setCookie(name, value, domain);
          cookieCount++;
        }
      }
      
      log(`Applied ${cookieCount} cookies for domain: ${domain}`);
      
      // Start redirect countdown
      let countdown = 5;
      statusElement.textContent = `‚úÖ Session ready. Redirecting in ${countdown}...`;
      
      const interval = setInterval(() => {
        countdown--;
        if (countdown <= 0) {
          clearInterval(interval);
          // Redirect to the target URL
          log(`Redirecting to: ${targetUrl}`);
          window.location.href = targetUrl;
        } else {
          statusElement.textContent = `‚úÖ Session ready. Redirecting in ${countdown}...`;
        }
      }, 1000);
    }
    
    function launchSession() {
      const urlParams = new URLSearchParams(window.location.search);
      const encoded = urlParams.get("s");
      
      if (!encoded) {
        document.getElementById("status").textContent = "‚ùå No session data found in URL.";
        return;
      }
      
      // Decode the session data
      const session = decodeSession(encoded);
      
      if (!session) {
        document.getElementById("status").textContent = "‚ùå Invalid or corrupted session data.";
        return;
      }
      
      // Determine if this is a queue session or an authenticated session
      const isQueueSession = session._is_queue_session || 
                            (session.url && session.url.includes("queue-it")) ||
                            (session.queueit_url && session.queueit_url.includes("queue-it")) ||
                            (session.enqueuetoken && !session.queueittoken);
      
      // Handle the session type appropriately
      if (isQueueSession) {
        handleQueueSession(session);
      } else {
        handleAuthSession(session);
      }
    }
    
    // Start the process
    document.addEventListener('DOMContentLoaded', launchSession);
  </script>
</body>
</html>
